<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZHTP Network Debug Console</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #00ff00;
            padding: 20px;
            margin: 0;
        }
        .console {
            background: #001100;
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 14px;
        }
        .section {
            margin: 20px 0;
            border: 1px solid #004400;
            border-radius: 5px;
            background: #001a00;
            padding: 15px;
        }
        .button {
            background: #003300;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 8px 15px;
            margin: 5px;
            cursor: pointer;
            border-radius: 3px;
        }
        .button:hover {
            background: #006600;
        }
        .status-good { color: #00ff00; }
        .status-warning { color: #ffff00; }
        .status-error { color: #ff0000; }
        .status-info { color: #00ffff; }
        h1, h2 { color: #00ff00; text-shadow: 0 0 5px #00ff00; }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .peer-list {
            max-height: 200px;
            overflow-y: auto;
            background: #000033;
            border: 1px solid #0066ff;
            padding: 10px;
            border-radius: 5px;
        }
        .peer-item {
            padding: 5px;
            margin: 2px 0;
            background: #001133;
            border-radius: 3px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ZHTP Network Debug Console</h1>
    
    <div class="section">
        <h2>ğŸ“¡ Network Status</h2>
        <div id="network-status" class="console"></div>
        <button class="button" onclick="refreshNetworkStatus()">ğŸ”„ Refresh Status</button>
        <button class="button" onclick="startAutoRefresh()">â–¶ï¸ Auto Refresh (5s)</button>
        <button class="button" onclick="stopAutoRefresh()">â¸ï¸ Stop Auto</button>
    </div>

    <div class="grid">
        <div class="section">
            <h2>ğŸ‘¥ Connected Peers</h2>
            <div id="peer-list" class="peer-list"></div>
            <button class="button" onclick="discoverPeers()">ğŸ” Discover Peers</button>
            <button class="button" onclick="refreshPeers()">ğŸ”„ Refresh Peers</button>
        </div>
        
        <div class="section">
            <h2>ğŸ“¨ DHT Messages</h2>
            <div id="dht-messages" class="console"></div>
            <button class="button" onclick="checkDHTMessages()">ğŸ“‹ Check DHT</button>
            <button class="button" onclick="clearDHT()">ğŸ—‘ï¸ Clear DHT</button>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ§ª P2P Testing</h2>
        <div>
            <label style="color: #00ff00;">Friend's IP Address:</label>
            <input type="text" id="friend-ip" placeholder="192.168.1.100" style="background: #003300; color: #00ff00; border: 1px solid #00ff00; padding: 5px; margin: 5px;">
            <button class="button" onclick="testConnection()">ğŸ”— Test Connection</button>
        </div>
        <div>
            <label style="color: #00ff00;">Friend's ZK Identity:</label>
            <input type="text" id="friend-zk" placeholder="zk_abc123...._zhtp" style="background: #003300; color: #00ff00; border: 1px solid #00ff00; padding: 5px; margin: 5px; width: 300px;">
            <button class="button" onclick="testMessage()">ğŸ“¤ Send Test Message</button>
        </div>
        <div id="test-results" class="console"></div>
    </div>

    <div class="section">
        <h2>ğŸ”§ Network Diagnostics</h2>
        <button class="button" onclick="getNetworkInfo()">ğŸŒ Network Info</button>
        <button class="button" onclick="checkFirewall()">ğŸ›¡ï¸ Check Firewall</button>
        <button class="button" onclick="testPorts()">ğŸ”Œ Test Ports</button>
        <button class="button" onclick="pingBootstrap()">ğŸ“¡ Ping Bootstrap</button>
        <div id="diagnostics" class="console"></div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let isConnected = false;

        function log(message, element = 'network-status', type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'status-info',
                good: 'status-good', 
                warning: 'status-warning',
                error: 'status-error'
            };
            
            const output = document.getElementById(element);
            const line = document.createElement('div');
            line.className = colors[type] || colors.info;
            line.textContent = `[${timestamp}] ${message}`;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        async function refreshNetworkStatus() {
            try {
                const response = await fetch('http://localhost:8000/api/status');
                const data = await response.json();
                
                log(`âœ… ZHTP Network Status: ${data.status}`, 'network-status', 'good');
                log(`ğŸ”— Connected Nodes: ${data.connected_nodes}`, 'network-status', 'info');
                log(`ğŸ­ Ceremony: ${data.ceremony_status}`, 'network-status', 'info');
                log(`ğŸ›ï¸ Consensus Rounds: ${data.consensus_rounds}`, 'network-status', 'info');
                log(`âš¡ ZK Transactions: ${data.zk_transactions}`, 'network-status', 'info');
                log(`ğŸ” Quantum Resistant: ${data.quantum_resistant}`, 'network-status', 'good');
                
                isConnected = true;
                
                // Also get network activity
                const activityResponse = await fetch('http://localhost:8000/api/network/activity');
                const activityData = await activityResponse.json();
                log(`ğŸ“Š Network Activity: ${JSON.stringify(activityData)}`, 'network-status', 'info');
                
            } catch (error) {
                log(`âŒ Failed to connect to ZHTP service: ${error.message}`, 'network-status', 'error');
                isConnected = false;
            }
        }

        async function refreshPeers() {
            try {
                // Try to get peer information from the network
                const response = await fetch('http://localhost:8000/api/debug/peers');
                const peers = await response.json();
                
                const peerList = document.getElementById('peer-list');
                peerList.innerHTML = '';
                
                if (peers && peers.length > 0) {
                    peers.forEach(peer => {
                        const peerDiv = document.createElement('div');
                        peerDiv.className = 'peer-item';
                        peerDiv.innerHTML = `
                            <strong>${peer.id || 'Unknown'}</strong><br>
                            IP: ${peer.address || 'N/A'}<br>
                            Status: <span class="status-${peer.connected ? 'good' : 'error'}">${peer.connected ? 'Connected' : 'Disconnected'}</span>
                        `;
                        peerList.appendChild(peerDiv);
                    });
                } else {
                    peerList.innerHTML = '<div class="status-warning">No peers found. You and your friend need to connect to the same network.</div>';
                }
            } catch (error) {
                document.getElementById('peer-list').innerHTML = `<div class="status-error">Error loading peers: ${error.message}</div>`;
            }
        }

        async function discoverPeers() {
            log('ğŸ” Starting peer discovery...', 'network-status', 'info');
            try {
                const response = await fetch('http://localhost:8000/api/debug/discover', {
                    method: 'POST'
                });
                const result = await response.json();
                log(`ğŸ” Peer discovery result: ${JSON.stringify(result)}`, 'network-status', 'info');
                
                // Refresh peer list after discovery
                setTimeout(refreshPeers, 2000);
            } catch (error) {
                log(`âŒ Peer discovery failed: ${error.message}`, 'network-status', 'error');
            }
        }

        async function checkDHTMessages() {
            try {
                const response = await fetch('http://localhost:8000/api/debug/dht');
                const dhtData = await response.json();
                
                const dhtConsole = document.getElementById('dht-messages');
                dhtConsole.innerHTML = '';
                
                log(`ğŸ“Š DHT Status: ${dhtData.status || 'Unknown'}`, 'dht-messages', 'info');
                log(`ğŸ“ Stored Messages: ${dhtData.message_count || 0}`, 'dht-messages', 'info');
                
                if (dhtData.messages && dhtData.messages.length > 0) {
                    dhtData.messages.forEach(msg => {
                        log(`ğŸ“¨ ${msg.from} -> ${msg.to}: "${msg.content.substring(0, 50)}..."`, 'dht-messages', 'warning');
                    });
                } else {
                    log('ğŸ“­ No messages in DHT storage', 'dht-messages', 'info');
                }
                
            } catch (error) {
                log(`âŒ DHT check failed: ${error.message}`, 'dht-messages', 'error');
            }
        }

        async function testConnection() {
            const friendIP = document.getElementById('friend-ip').value;
            if (!friendIP) {
                log('âŒ Please enter your friend\'s IP address', 'test-results', 'error');
                return;
            }
            
            log(`ğŸ”— Testing connection to ${friendIP}:8000...`, 'test-results', 'info');
            
            try {
                // Test if friend's ZHTP service is reachable
                const response = await fetch(`http://${friendIP}:8000/api/status`, {
                    method: 'GET',
                    mode: 'no-cors' // This might be blocked by CORS, but we'll try
                });
                
                log(`âœ… Connection to ${friendIP}:8000 successful!`, 'test-results', 'good');
                
                // Try to add them as a peer
                const addPeerResponse = await fetch('http://localhost:8000/api/debug/add-peer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        address: `${friendIP}:8000`
                    })
                });
                
                if (addPeerResponse.ok) {
                    log(`âœ… Added ${friendIP} as peer successfully!`, 'test-results', 'good');
                } else {
                    log(`âš ï¸ Connected but couldn't add as peer`, 'test-results', 'warning');
                }
                
            } catch (error) {
                log(`âŒ Connection to ${friendIP}:8000 failed: ${error.message}`, 'test-results', 'error');
                log(`ğŸ’¡ Make sure your friend's ZHTP service is running on port 8000`, 'test-results', 'warning');
            }
        }

        async function testMessage() {
            const friendZK = document.getElementById('friend-zk').value;
            if (!friendZK) {
                log('âŒ Please enter your friend\'s ZK Identity', 'test-results', 'error');
                return;
            }
            
            log(`ğŸ“¤ Sending test message to ${friendZK}...`, 'test-results', 'info');
            
            try {
                const response = await fetch('http://localhost:8000/api/messages/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: friendZK,
                        message: `Test message from ZHTP Debug Console at ${new Date().toLocaleTimeString()}`,
                        from: 'debug_console',
                        zk_identity: 'debug_zk_identity'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`âœ… Message sent! ID: ${result.message_id}`, 'test-results', 'good');
                    log(`ğŸ“ Delivery: ${result.delivery_status}`, 'test-results', 'info');
                    log(`ğŸ” Encryption: ${result.encryption_algorithm}`, 'test-results', 'info');
                } else {
                    log(`âŒ Message failed: ${result.error || 'Unknown error'}`, 'test-results', 'error');
                }
                
            } catch (error) {
                log(`âŒ Message sending failed: ${error.message}`, 'test-results', 'error');
            }
        }

        async function getNetworkInfo() {
            log('ğŸŒ Getting network information...', 'diagnostics', 'info');
            
            // Get local IP addresses
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                log(`ğŸŒ Public IP: ${data.ip}`, 'diagnostics', 'info');
            } catch {
                log('âš ï¸ Could not get public IP', 'diagnostics', 'warning');
            }
            
            // Check local network info
            log('ğŸ’» Local network: Check your router settings for port forwarding', 'diagnostics', 'warning');
            log('ğŸ”Œ ZHTP Port: 8000 (make sure this is open in firewall)', 'diagnostics', 'info');
        }

        async function checkFirewall() {
            log('ğŸ›¡ï¸ Firewall Check:', 'diagnostics', 'info');
            log('ğŸ“ Windows: Windows Defender Firewall should allow port 8000', 'diagnostics', 'warning');
            log('ğŸ“ Router: Port forwarding may be needed for external connections', 'diagnostics', 'warning');
            log('ğŸ“ To test locally: Use 192.168.x.x addresses on same WiFi', 'diagnostics', 'info');
        }

        async function testPorts() {
            log('ğŸ”Œ Testing ZHTP ports...', 'diagnostics', 'info');
            
            try {
                const response = await fetch('http://localhost:8000/api/status');
                if (response.ok) {
                    log('âœ… Port 8000: Open and responding', 'diagnostics', 'good');
                } else {
                    log('âŒ Port 8000: Responding but with errors', 'diagnostics', 'error');
                }
            } catch (error) {
                log('âŒ Port 8000: Not responding', 'diagnostics', 'error');
            }
        }

        async function pingBootstrap() {
            log('ğŸ“¡ Pinging bootstrap nodes...', 'diagnostics', 'info');
            
            const bootstrapNodes = [
                'localhost:8000',
                '127.0.0.1:8000'
            ];
            
            for (const node of bootstrapNodes) {
                try {
                    const response = await fetch(`http://${node}/api/status`);
                    if (response.ok) {
                        log(`âœ… Bootstrap node ${node}: Reachable`, 'diagnostics', 'good');
                    } else {
                        log(`âš ï¸ Bootstrap node ${node}: Responding but errors`, 'diagnostics', 'warning');
                    }
                } catch (error) {
                    log(`âŒ Bootstrap node ${node}: Unreachable`, 'diagnostics', 'error');
                }
            }
        }

        function clearDHT() {
            document.getElementById('dht-messages').innerHTML = '';
            log('ğŸ—‘ï¸ DHT console cleared', 'dht-messages', 'info');
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) return;
            
            autoRefreshInterval = setInterval(() => {
                refreshNetworkStatus();
                refreshPeers();
                checkDHTMessages();
            }, 5000);
            
            log('â–¶ï¸ Auto-refresh started (every 5 seconds)', 'network-status', 'good');
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                log('â¸ï¸ Auto-refresh stopped', 'network-status', 'warning');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸ” ZHTP Debug Console initialized', 'network-status', 'good');
            refreshNetworkStatus();
            refreshPeers();
            checkDHTMessages();
        });
    </script>
</body>
</html>
